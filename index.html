<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CONSULTA ESTADO FISE</title>

  <!-- Librer√≠as -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --azul:#0D47A1;
      --verde:#2E7D32;
      --bg:#f6f8fb;
      --card:#ffffff;
    }
    body{font-family:Inter, Arial, sans-serif;background:var(--bg);margin:0;padding:18px;color:#222}
    header{display:flex;align-items:center;gap:12px}
    header img{height:64px}
    .title{font-size:20px;font-weight:700;color:var(--azul)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    input[type="text"]{padding:10px;border-radius:6px;border:1px solid #ccc;min-width:220px}
    button{background:var(--azul);color:white;border:none;padding:10px 12px;border-radius:6px;cursor:pointer}
    button.secondary{background:var(--verde)}
    .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 6px 20px rgba(10,20,40,0.06);margin-top:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .small{font-size:13px;color:#666}
    .top-row{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .note{font-size:13px;color:#555;margin-top:8px}
    #progress{color:var(--azul);font-weight:600;margin-top:6px}
    tr.total-row td{font-weight:bold;background:#eaf3ff;}
    @media(max-width:720px){ header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>

  <header>
    <img id="repo-logo" src="assets/logo.png" alt="Logo" onerror="this.style.display='none'">
    <div>
      <div class="title">CONSULTA ESTADO FISE</div>
      <div class="small">Busca por DNI o SUMINISTRO ‚Äî exporta a Excel o PDF</div>
    </div>
  </header>

  <div class="controls card">
    <div class="top-row">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="fileName" type="text" placeholder="Base (ej. data)" />
        <button id="btnLoad">Cargar datos</button>
        <button id="btnLoadLocal" class="secondary">Cargar archivo local</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <input id="searchInput" type="text" placeholder="Ingresar DNI o SUMINISTRO" />
        <button id="btnSearch">Buscar</button>
        <button id="btnClear" class="secondary">Limpiar</button>
      </div>
    </div>

    <div id="progress"></div>

    <div class="note">
      <ul>
        <li>Sube tus archivos <code>data_1.json</code>, <code>data_2.json</code>, etc., junto al HTML.</li>
        <li>En ‚ÄúBase‚Äù escribe <code>data</code> (sin n√∫mero) y presiona <b>Cargar datos</b>.</li>
        <li>O usa <b>Cargar archivo local</b> si prefieres leer desde tu PC.</li>
      </ul>
    </div>
  </div>

  <div id="resultsCard" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong id="countLbl">0</strong> registros encontrados</div>
      <div style="display:flex;gap:8px">
        <button id="btnExportExcel">Exportar a Excel</button>
        <button id="btnExportPDF" class="secondary">Exportar a PDF</button>
      </div>
    </div>

    <div style="overflow:auto;margin-top:12px">
      <table id="resultsTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
let DB = [];
let currentResults = [];

/* ========== UTILIDADES ========== */
function showMessage(msg){ alert(msg); }

/* üîπ Cargar m√∫ltiples archivos data_1.json, data_2.json, ... */
async function loadFromRepo(baseName){
  if(!baseName) baseName="data";
  DB=[]; let index=1,total=0;
  const progress=document.getElementById("progress");
  progress.innerText="Cargando...";
  while(true){
    const fileName=`${baseName}_${index}.json`;
    try{
      const resp=await fetch(fileName);
      if(!resp.ok){ if(index===1) throw new Error("No se encontr√≥ "+fileName); else break; }
      const json=await resp.json();
      if(Array.isArray(json)){ DB=DB.concat(json); total+=json.length;
        progress.innerText=`Cargado ${fileName} (${json.length} registros, total ${total})`;
      } else console.warn(fileName+" no es un array v√°lido");
      index++;
    }catch(e){ if(index===1) showMessage("Error: "+e.message); break; }
  }
  if(total===0){ progress.innerText="No se cargaron datos."; return; }
  progress.innerText=`Carga completada: ${total} registros.`;
  renderResults();
}

/* üîπ Cargar archivo local */
function loadFromLocalFile(file){
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const json=JSON.parse(e.target.result);
      if(!Array.isArray(json)) throw new Error("Debe ser un array");
      DB=json; showMessage(`Cargado ${DB.length} registros.`); renderResults();
    }catch(err){ showMessage("Error JSON: "+err.message); }
  };
  reader.readAsText(file);
}

/* üîπ Buscar */
function searchTerm(term){
  if(!term){ currentResults=[]; renderResults(); return; }
  const q=term.trim().toLowerCase();
  currentResults=DB.filter(r=>{
    return (r["DNI"] && r["DNI"].toString().toLowerCase().includes(q)) ||
           (r["SUMINISTRO"] && r["SUMINISTRO"].toString().toLowerCase().includes(q)) ||
           (r["CODIGO DE USUARIO"] && r["CODIGO DE USUARIO"].toString().toLowerCase().includes(q));
  });
  renderResults();
}

/* üîπ Render tabla con columnas fijas + TOTAL */
function renderResults(){
  const card=document.getElementById('resultsCard');
  const tbody=document.querySelector('#resultsTable tbody');
  const thead=document.querySelector('#resultsTable thead');
  tbody.innerHTML=''; thead.innerHTML='';
  if(!currentResults.length){card.style.display='none';document.getElementById('countLbl').innerText='0';return;}
  card.style.display='block';
  document.getElementById('countLbl').innerText=currentResults.length;

  const headers=['DNI','UU.NN','CODIGO DE USUARIO','APELLIDOS Y NOMBRES','PERIODO','N¬∞ BOLETA','MONTO','DISTRITO','CENTROPOBLADO','ESTADO'];

  // Cabecera
  const headerRow=document.createElement('tr');
  headers.forEach(h=>{const th=document.createElement('th');th.textContent=h;headerRow.appendChild(th);});
  thead.appendChild(headerRow);

  // Filas
  let totalMonto=0;
  currentResults.forEach(r=>{
    const tr=document.createElement('tr');
    headers.forEach(h=>{
      let val=r[h]||'';
      if(h==='MONTO'){
        const num=parseFloat(val.toString().replace(/[^0-9.-]+/g,''));
        if(!isNaN(num)) totalMonto+=num;
      }
      const td=document.createElement('td');td.textContent=val;tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Fila total
  const trTotal=document.createElement('tr');trTotal.classList.add('total-row');
  headers.forEach(h=>{
    const td=document.createElement('td');
    if(h==='MONTO'){td.textContent=totalMonto.toFixed(2);}
    else if(h==='DNI'){td.textContent='TOTAL';}
    trTotal.appendChild(td);
  });
  tbody.appendChild(trTotal);
}

/* üîπ Exportar a Excel */
function exportToExcel(){
  if(!currentResults.length){showMessage('No hay resultados');return;}
  const headers=['DNI','UU.NN','CODIGO DE USUARIO','APELLIDOS Y NOMBRES','PERIODO','N¬∞ BOLETA','MONTO','DISTRITO','CENTROPOBLADO','ESTADO'];
  const ws_data=[headers];
  let totalMonto=0;
  currentResults.forEach(r=>{
    const row=headers.map(h=>{
      const val=r[h]||''; if(h==='MONTO'){const num=parseFloat(val.toString().replace(/[^0-9.-]+/g,''));if(!isNaN(num))totalMonto+=num;} return val;
    });
    ws_data.push(row);
  });
  const totalRow=Array(headers.length).fill(''); totalRow[0]='TOTAL'; totalRow[6]=totalMonto.toFixed(2); ws_data.push(totalRow);
  const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,'Resultados');
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  saveAs(new Blob([wbout],{type:'application/octet-stream'}),'resultados_fise.xlsx');
}

/* üîπ Exportar a PDF */
function exportToPDF(){
  if(!currentResults.length){showMessage('No hay resultados');return;}
  const { jsPDF }=window.jspdf; const doc=new jsPDF('l','pt','a4');
  const img=document.getElementById('repo-logo');
  try{if(img && img.complete && img.naturalWidth!==0) doc.addImage(img,'PNG',40,20,80,40);}catch(e){}
  doc.setFontSize(14); doc.text('Reporte - Consulta Estado FISE',150,40);
  const headers=['DNI','UU.NN','CODIGO DE USUARIO','APELLIDOS Y NOMBRES','PERIODO','N¬∞ BOLETA','MONTO','DISTRITO','CENTROPOBLADO','ESTADO'];
  const rows=[]; let totalMonto=0;
  currentResults.forEach(r=>{
    const row=headers.map(h=>{
      const val=r[h]||''; if(h==='MONTO'){const num=parseFloat(val.toString().replace(/[^0-9.-]+/g,''));if(!isNaN(num))totalMonto+=num;} return val;
    });
    rows.push(row);
  });
  const totalRow=Array(headers.length).fill(''); totalRow[0]='TOTAL'; totalRow[6]=totalMonto.toFixed(2); rows.push(totalRow);
  doc.autoTable({head:[headers],body:rows,startY:80,styles:{fontSize:8,cellPadding:3},headStyles:{fillColor:[13,71,161]}});
  doc.save('resultados_fise.pdf');
}

/* üîπ Eventos */
document.getElementById('btnLoad').addEventListener('click',()=>{const base=document.getElementById('fileName').value.trim();loadFromRepo(base||'data');});
document.getElementById('btnLoadLocal').addEventListener('click',()=>{const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{if(e.target.files[0])loadFromLocalFile(e.target.files[0]);};inp.click();});
document.getElementById('btnSearch').addEventListener('click',()=>{searchTerm(document.getElementById('searchInput').value);});
document.getElementById('btnClear').addEventListener('click',()=>{document.getElementById('searchInput').value='';currentResults=[];renderResults();});
document.getElementById('btnExportExcel').addEventListener('click',exportToExcel);
document.getElementById('btnExportPDF').addEventListener('click',exportToPDF);
document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('btnSearch').click();});
</script>
</body>
</html>
